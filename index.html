<!-- <!doctype html> -->
<html>
  <head>
    <title>Socket.IO chat</title>
  </head>
  <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">


var socket = io();
var canvas, ctx, flag = false,
    prevX = 0,
    currX = 0,
    prevY = 0,
    currY = 0,
    dot_flag = false;

var x = "black", // stroke style
    y = 2;  // line witdh



function init() {
    canvas = document.getElementById('can');
    ctx = canvas.getContext("2d");
    w = canvas.width;
    h = canvas.height;

    canvas.addEventListener("mousemove", function (e) {
        findxy('move', e)
    }, false);
    canvas.addEventListener("mousedown", function (e) {
        findxy('down', e)
    }, false);
    canvas.addEventListener("mouseup", function (e) {
        findxy('up', e)
    }, false);
    canvas.addEventListener("mouseout", function (e) {
        findxy('out', e)
    }, false);


}




function draw() {
    ctx.beginPath();
    socket.emit('drawing', {'prevX':prevX, 'prevY':prevY,'currX':currX, 'currY':currY, 'color': x });
    ctx.moveTo(prevX, prevY);
    ctx.lineTo(currX, currY);
    ctx.strokeStyle = x;
    ctx.lineWidth = y;
    ctx.stroke();
    ctx.closePath();

  }

socket.on('drawing', function(drawObj){
    ctx.beginPath();
    ctx.moveTo(drawObj.prevX, drawObj.prevY);
    ctx.lineTo(drawObj.currX, drawObj.currY);
    ctx.strokeStyle = drawObj.x;
    ctx.lineWidth = y;
    ctx.stroke();
    ctx.closePath();
    });

socket.emit('getUrl', {'currentUrl':window.location.href});


//get old drawings
socket.on('PreviousDrawing', function(drawObj){
    console.log('je suis arrve', drawObj);
    drawObj.forEach(function(element){
        ctx.beginPath();
        ctx.moveTo(element.prevX, element.prevY);
        ctx.lineTo(element.currX, element.currY);
        ctx.strokeStyle = element.color;
        ctx.lineWidth = y;
        ctx.stroke();
        ctx.closePath();
        })
    });

socket.on('color', function(color){
    x = allColors[color];
})

// socket.on('colorPerRoom', function(CPR){
//     console.log('je recoi colorpersroon', CPR);

//     for (var key in CPR ){
//         console.log(window.location.href, key)
//         if ( window.location.href === key ){
//             console.log('usercc',allColors[CPR[key].userCount]);
//              x = allColors[CPR[key].userCount];
//         }

//     }
//     // x = allColors[color];
// })
function findxy(res, e) {
    if (res == 'down') {
        prevX = currX;
        prevY = currY;
        currX = e.clientX - canvas.offsetLeft;
        currY = e.clientY - canvas.offsetTop;

        flag = true;
        dot_flag = true;
        if (dot_flag) {
            ctx.beginPath();
            ctx.fillStyle = x;
            ctx.fillRect(currX, currY, 2, 2);
            ctx.closePath();
            dot_flag = false;
        }
    }
    if (res == 'up' || res == "out") {
        flag = false;
    }
    if (res == 'move') {
        if (flag) {
            prevX = currX;
            prevY = currY;
            currX = e.clientX - canvas.offsetLeft;
            currY = e.clientY - canvas.offsetTop;
            draw();
        }
    }
}
function getCurrentUrl(){
    return window.location.href;
}

var allColors = ["red","blue","green","yellow","black","Fuchsia","Brown","Gainsboro","GhostWhite","Gold","GoldenRod","Gray","Grey","Green","GreenYellow","HoneyDew","HotPink","IndianRed","Indigo","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGrey","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon"];
</script>
  <body onload="init()">
    <canvas id="can" width="400" height="400" style="position:absolute;top:10%;left:10%;border:2px solid;"></canvas>
</body>
</html>